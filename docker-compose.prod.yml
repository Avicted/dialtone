services:
  dialtone:
    build:
      context: my_applications/dialtone
      dockerfile: Dockerfile
    image: dialtone:latest
    container_name: dialtone
    env_file:
      - my_applications/dialtone/.env
    depends_on:
      - dialtone-postgres

  dialtone-postgres:
    image: postgres:15-alpine
    env_file:
      - my_applications/dialtone/.env
    volumes:
      - dialtone_pg:/var/lib/postgresql/data

  dialtone-coturn:
    image: coturn/coturn:4.8.0-alpine
    restart: unless-stopped
    env_file:
      - my_applications/dialtone/.env
    user: "0:0"
    read_only: true
    tmpfs:
      - /tmp
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    volumes:
      - ./deploy/coturn/certs:/etc/coturn/certs:ro
    command:
      - -n
      - --log-file=stdout
      - --fingerprint
      - --lt-cred-mech
      - --stale-nonce
      - --user=$${TURN_USER:?set TURN_USER}:$${TURN_PASS:?set TURN_PASS}
      - --realm=$${TURN_REALM:?set TURN_REALM}
      - --external-ip=$${TURN_EXTERNAL_IP:?set TURN_EXTERNAL_IP}
      - --no-cli
      - --cert=$${TURN_CERT_FILE:-/etc/coturn/certs/fullchain.pem}
      - --pkey=$${TURN_KEY_FILE:-/etc/coturn/certs/privkey.pem}
      - --no-dtls
      - --no-multicast-peers
      - --listening-port=$${TURN_PORT:-3478}
      - --tls-listening-port=$${TURN_TLS_PORT:-5349}
      - --min-port=$${TURN_MIN_PORT:-49152}
      - --max-port=$${TURN_MAX_PORT:-49252}
    ports:
      - "${TURN_PORT:-3478}:${TURN_PORT:-3478}/udp"
      - "${TURN_PORT:-3478}:${TURN_PORT:-3478}/tcp"
      - "${TURN_TLS_PORT:-5349}:${TURN_TLS_PORT:-5349}/tcp"
      - "${TURN_MIN_PORT:-49152}-${TURN_MAX_PORT:-49252}:${TURN_MIN_PORT:-49152}-${TURN_MAX_PORT:-49252}/udp"

volumes:
  dialtone_pg:
