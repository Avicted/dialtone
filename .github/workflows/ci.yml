name: ci

on:
  pull_request:
    branches:
      - "**"

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          cache: true

      - name: Install native dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libopus-dev \
            libopusfile-dev \
            libx11-dev \
            libxtst-dev \
            xvfb \
            xauth

      - name: Go fmt
        run: go fmt ./...

      - name: Go vet
        run: go vet ./...

      - name: Go test
        run: xvfb-run -a go test ./...

      - name: Coverage
        run: xvfb-run -a ./scripts/coverage.sh | tee coverage-report.txt

      - name: Upload coverage profile
        uses: actions/upload-artifact@v4
        with:
          name: coverage-profile
          path: coverage.out
          if-no-files-found: error

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage-report.txt
          if-no-files-found: error
